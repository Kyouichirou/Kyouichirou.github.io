<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="Lian个人博客-数据与思考">
<meta name="description" content="Make Thing Better and Simpler">
<meta name="theme-color" content="#000">
<title>MySQL-递归-日期 | Lian</title>
<link rel="shortcut icon" href="/favicon.ico?v=1758516680740">
<link rel="stylesheet" href="/media/css/mist.css">
<link rel="stylesheet" href="/media/fonts/font-awesome.css">
<link
  href="//fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"
  rel="stylesheet" type="text/css">

<link href="/media/hljs/styles/tomorrow-night.css"
  rel="stylesheet">

<link rel="stylesheet" href="/styles/main.css">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/media/js/jquery.js"></script>
<script src="/media/hljs/highlight.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.0/languages/vbnet.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.0/languages/vbscript-html.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.0/languages/vbscript.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.0/languages/sql.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/velocity/1.5.1/velocity.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/velocity/1.5.1/velocity.ui.min.js"></script>
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.11.1/katex.min.css"
  integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ["\\(", "\\)"]],
      displayMath: [['$$', '$$'], ["\\[", "\\]"]]
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'a', 'annotation', 'annotation-xml'],
      ignoreHtmlClass: 'tex2jax_ignore|crayon-.*', // 'crayon-' 开头的类，属于Wordpress代码高亮库，这部分不需要处理，否则会导致显示不正确,这部分是正则式，多条之间用'|'分割
      processHtmlClass: 'tex2jax_process'
    },
    //禁用右键菜单	
    renderActions: {
      addMenu: [0, '', '']
    }
  };
</script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>




<script>
  var _hmt = _hmt || [];
  (function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?19bd452dc174a21cc99fb66ddfcef0cc";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>



  <meta name="description" content="MySQL-递归-日期" />
  <meta name="keywords" content="postgresql,mysql" />
</head>

<body>
  <div class="head-top-line"></div>
  <div class="header-box">
    
<div class="mist">
  <header class="header bg-color ">
    <div class="blog-header box-shadow-wrapper  " id="header">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-meta">       
        <div class="site-title">
          
            <a href="/" class="">
              <span class="logo-line-before">
                <i class=""></i>
              </span>
              <span class="main-title">Lian</span>
              <span class="logo-line-after">
                <i class=""></i>
              </span>
            </a>  
          
        </div>
        
      </div>
      <nav class="site-nav" id="site_nav">
        <ul id="nav_ul">
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/" target="_self">
                  <i class="fa fa-globe"></i> Home
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/archives" target="_self">
                  <i class="fa fa-globe"></i> Archives
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/tags" target="_self">
                  <i class="fa fa-globe"></i> Tags
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="https://Kyouichirou.github.io/post/about-me" target="_self">
                  <i class="fa fa-globe"></i> About
                </a>
              
            </li>
          
          
            
              <li class="nav-item ">
                <a href="/friends/" target="_self">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </li>
            
          
          
        </ul>
      </nav>
    </div>
  </header>
</div>

<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function navClick() {
    let sideBar = document.querySelector('.sidebar');
    let navUl = document.querySelector('#nav_ul');
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
    if (siteNav.classList.contains('nav-menu-active')) {
      siteNav.style = "height: " + (navUl.children.length * 42) +"px !important";
    } else {
      siteNav.style = "";
    }
  }

  navToggle.addEventListener('click',navClick);  
</script>
  </div>
  <div class="main-continer">
    
    <div
      class="section-layout mist bg-color">
      <div class="section-layout-wrapper">
        

<div class="sidebar">
  
    <div class="sidebar-box box-shadow-wrapper  right-motion" id="sidebar">
      
        <div class="post-list-sidebar">
          <div class="sidebar-title">
            <span id="tocSideBar" class="sidebar-title-item sidebar-title-active language" data-lan="index">文章目录</span>
            <span id="metaSideBar" class="sidebar-title-item language" data-lan="preview">站点概览</span>
          </div>
        </div>
      
      <div class="sidebar-body mist" id="sidebar_body">
        
          
            <div class="post-side-meta" id="post_side_meta">
              
<div class="sidebar-wrapper box-shadow-wrapper ">
  <div class="sidebar-item">
    <img class="site-author-image right-motion" src="/images/avatar.png"/>
    <p class="site-author-name">Lian</p>
    
    <div class="site-description right-motion">
      
      
      
        <p>make thing better and simpler.</p>
      
      
    </div>
    
  </div>
  <div class="sidebar-item side-item-stat right-motion">
    <div class="sidebar-item-box">
      <a href="/archives/">
        
        <span class="site-item-stat-count">103</span>
        <span class="site-item-stat-name language" data-lan="article">文章</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="/tags/">
        <span class="site-item-stat-count">64</span>
        <span class="site-item-stat-name language" data-lan="tag">标签</span>
      </a>
    </div>
  </div>
  
  



</div>
            </div>
            <div class="post-toc sidebar-body-active" id="post_toc" style="opacity: 1;">
              <div class="toc-box right-motion">
  <div class="toc-wrapper  auto"
    id="toc_wrapper">
    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%B8%80-%E9%80%92%E5%BD%92">一. 递归</a></li>
<li><a href="#%E4%BA%8C-%E6%97%A5%E5%8E%86">二. 日历</a>
<ul>
<li><a href="#21-%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2">2.1 行列转换</a>
<ul>
<li><a href="#211-postgresql">2.1.1 PostgreSQL</a></li>
<li><a href="#212-mysql">2.1.2 MySQL</a></li>
</ul>
</li>
<li><a href="#22-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%97%A5%E6%9C%9F%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">2.2 涉及的日期处理函数</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div>

<script>

  let lastTop = 0, lList = [], hList = [], postBody, lastIndex = -1;
  let active = 'active-show', activeClass = 'active-current';
  let tocWrapper = document.querySelector('#toc_wrapper');
  let tocContent = tocWrapper.children[0];
  let autoNumber = tocWrapper && tocWrapper.classList.contains('auto-number');

  function addTocNumber(elem, deep) {
    if (!elem) {
      return;
    }
    let prop = elem.__proto__;

    if (prop === HTMLUListElement.prototype) {
      for (let i = 0; i < elem.children.length; i++) {
        addTocNumber(elem.children[i], deep + (i + 1) + '.');
      }
    } else if (prop === HTMLLIElement.prototype) {
      // 保存li元素
      if (elem.children[0] && elem.children[0].__proto__ === HTMLAnchorElement.prototype) {
        lList.push(elem);
      }
      for (let i = 0; i < elem.children.length; i++) {
        let cur = elem.children[i];
        if (cur.__proto__ === HTMLAnchorElement.prototype) {
          if (autoNumber) {
            cur.text = deep + ' ' + cur.text;
          }
        } else if (cur.__proto__ === HTMLUListElement.prototype) {
          addTocNumber(cur, deep);
        }
      }
    }
  }

  function removeParentActiveClass() {
    let parents = tocContent.querySelectorAll('.' + active)
    parents.forEach(function (elem) {
      elem.classList.remove(active);
    });
  }

  function addActiveClass(index) {
    if (index >= 0 && index < hList.length) {
      lList[index].classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < hList.length) {
      lList[index].classList.remove(activeClass);
    }
  }

  function addActiveLiElemment(elem, parent) {
    if (!elem || elem === parent) {
      return;
    } else {
      if (elem.__proto__ === HTMLLIElement.prototype) {
        elem.classList.add(active);
      }
      addActiveLiElemment(elem.parentElement, parent);
    }
  }

  function showToc() {
    if (tocWrapper) {
      postBody = document.querySelector('#post_body');
      for (let i = 0; i < postBody.children.length; i++) {
        if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
          hList.push(postBody.children[i]);
        }
      }
      if (tocWrapper.classList.contains('compress')) {
        tocContent.classList.add('closed');
      } else if (tocWrapper.classList.contains('no_compress')) {
        tocContent.classList.add('expanded');
      } else {
        if (hList.length > 10) {
          active = 'active-hidden'
          tocContent.classList.add('closed');
        } else {
          tocContent.classList.add('expanded');
        }
      }
    }
  }

  (function () {
    // 处理不是从#一级标题开始目录
    if (tocContent.children.length === 1 && tocContent.children[0].__proto__ === HTMLLIElement.prototype) {
      let con = tocContent.children[0].children[0];
      tocContent.innerHTML = con.innerHTML;
    }
    let markdownItTOC = document.querySelector('.markdownIt-TOC');
    let innerHeight = window.innerHeight;
    markdownItTOC.style = `max-height: ${innerHeight - 80 > 0 ? innerHeight - 80 : innerHeight}px`
    addTocNumber(tocContent, '');
  })();

  document.addEventListener('scroll', function (e) {
    if (lList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop + 10;
    let dir;

    if (lastTop - scrollTop > 0) {
      dir = 'up';
    } else {
      dir = 'down';
    }

    lastTop = scrollTop;
    if (scrollTop <= 0) {
      if (lastIndex >= 0 && lastIndex < hList.length) {
        lList[lastIndex].classList.remove(activeClass);
      }
      return;
    }

    let current = 0, hasFind = false;
    for (let i = 0; i < hList.length; i++) {
      if (hList[i].offsetTop > scrollTop) {
        current = i;
        hasFind = true;
        break;
      }
    }
    if (!hasFind && scrollTop > lList[lList.length - 1].offsetTop) {
      current = hList.length - 1;
    } else {
      current--;
    }
    if (dir === 'down') {
      if (current > lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex)
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement, tocContent);
      }
    } else {
      if (current < lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex);
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement, tocContent);
      }
    }
  });


  window.addEventListener('load', function () {
    showToc();
    document.querySelector('#sidebar').style = 'display: block;';
    tocWrapper.classList.add('toc-active');
    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })

</script>
            </div>
          
        
      </div>
    </div>
  
</div>
<script>
  const SIDEBAR_TITLE_ACTIVE = 'sidebar-title-active';
  const SIDEBAR_BODY_ACTIVE = 'sidebar-body-active';
  const SLIDE_UP_IN = 'slide-up-in';

  let sidebar = document.querySelector('#sidebar'),
  tocSideBar = document.querySelector('#tocSideBar'),
  metaSideBar = document.querySelector('#metaSideBar'),
  postToc = document.querySelector('#post_toc'),
  postSiteMeta = document.querySelector('#post_side_meta'),
  sidebarTitle = document.querySelector('.sidebar-title'),
  sidebarBody = document.querySelector('#sidebar_body');

  tocSideBar && tocSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  metaSideBar && metaSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  function toggleSidebar(e) {
    let currentTitle = document.querySelector("."+SIDEBAR_TITLE_ACTIVE);
    if (currentTitle == e.srcElement) {
      return ;
    }
    let current, showElement, hideElement;
    if (e.srcElement == metaSideBar) {
      showElement = postSiteMeta;
      hideElement = postToc;
    } else if (e.srcElement == tocSideBar){
      showElement = postToc;
      hideElement = postSiteMeta;
    }
    currentTitle.classList.remove(SIDEBAR_TITLE_ACTIVE);
    e.srcElement.classList.add(SIDEBAR_TITLE_ACTIVE);

    jQuery.Velocity(hideElement, 'stop');
    jQuery.Velocity(hideElement, 'transition.slideUpOut', {
      display: 'none',
      duration: 200,
      complete: function () {
        jQuery.Velocity(showElement, 'transition.slideDownIn', {
          duration: 200
        });
      }
    })
    hideElement.classList.remove(SIDEBAR_BODY_ACTIVE);
    showElement.classList.add(SIDEBAR_BODY_ACTIVE);
  }

  postToc && postToc.addEventListener('transitionend', function() {
    this.classList.remove(SLIDE_UP_IN);
  });

  if (sidebarBody) {
    if (sidebarBody.classList.contains('pisces') || sidebarBody.classList.contains('gemini')) {
      let hasFix = false;
      let scrollEl = document.querySelector('.main-continer');
      let limitTop = document.querySelector('#nav_ul').children.length * 42 + 162;
      window.addEventListener('scroll', function(e) {
        if (document.scrollingElement.scrollTop >= limitTop) {
          if (!hasFix) {
            sidebar.classList.add('sidebar-fixed');
            hasFix = true;
          }
        } else {
          if (hasFix) {
            sidebar.classList.remove('sidebar-fixed');
            hasFix = false;
          }
        }
      });
    }
  }
  
</script>
        <div class="section-box box-shadow-wrapper">
          <div class="section bg-color post post-page">
            <section class="post-header">
  <h1 class="post-title">
    <a class="post-title-link" href="https://Kyouichirou.github.io/post/mysql-di-gui-ri-qi/"> MySQL-递归-日期 </a>
  </h1>
  <div class="post-meta">
    
    <span class="meta-item pc-show">
      <i class="fa fa-calendar-o"></i>
      <span class="language" data-lan="publish">发布于</span>
      <span class="publish-time" data-t="2023-03-14 19:12:19">2023-03-14</span>
      <span class="post-meta-divider pc-show">|</span>
    </span>
    
    <span class="meta-item">
      <i class="fa fa-folder-o"></i>
      <span class="pc-show language" data-lan="category-in">标签:</span>
       
      <a href="https://Kyouichirou.github.io/tag/7Syg7ifp4/"> <span>postgresql</span> </a>、   
      <a href="https://Kyouichirou.github.io/tag/53itHjBFa/">
        <span>mysql</span>
      </a>
       
    </span>
    <span class="post-meta-divider">|</span>
    
    <span class="meta-item">
      <i class="fa fa-clock-o"></i>
      <span
        >11<span class="language" data-lan="minute"
          >分钟</span
        ></span
      >
    </span>
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-file-word-o"></i>
      <span
        >1900<span class="pc-show language" data-lan="words"
          >字数</span
        ></span
      >
    </span>
    
  </div>
</section>

            <div class="post-body next-md-body" id="post_body">
              <p>本文作为<code>MySQL使用指南</code>的延申讨论</p>
<ul>
<li>递归</li>
<li>行列转换</li>
<li>日期/时间处理相关函数</li>
</ul>
<h2 id="一-递归">一. 递归</h2>
<figure data-type="image" tabindex="1"><img src="http://www.begtut.com/wp-content/uploads/2019/08/MySQL-Recursive-CTE.png" alt="MySQL-Recursive-CTE.png" loading="lazy"></figure>
<blockquote>
<p>As mentioned previously, recursive common table expressions (CTEs) are frequently used for series generation and traversing hierarchical or tree-structured data.</p>
</blockquote>
<!--more-->
<blockquote>
<p>递归成员不得包含以下结构:</p>
<ul>
<li>聚合函数 例如<a href="https://www.begtut.com/mysql/mysql-max-function.html">MAX</a> <a href="https://www.begtut.com/mysql/mysql-min.html">MIN</a> <a href="https://www.begtut.com/mysql/mysql-sum.html">SUM</a> <a href="https://www.begtut.com/mysql/mysql-avg.html">AVG</a> <a href="https://www.begtut.com/mysql/mysql-count.html">COUNT</a>等.</li>
<li><a href="https://www.begtut.com/mysql/mysql-group-by.html">GROUP BY</a>子句</li>
<li><a href="https://www.begtut.com/mysql/mysql-order-by.html">ORDER BY</a>子句</li>
<li><a href="https://www.begtut.com/mysql/mysql-limit.html">LIMIT</a> 子句</li>
<li><a href="https://www.begtut.com/mysql/mysql-distinct.html">DISTINCT</a></li>
</ul>
</blockquote>
<blockquote>
<p>递归<a href="https://www.begtut.com/mysql/mysql-cte.html">公用表表达式</a> ( CTE) 是一个CTE 它有一个子查询 它引用CTE名称本身. 以下说明了递归CTE的语法</p>
<pre><code class="language-mysql">WITH RECURSIVE cte_name AS (
initial_query -- anchor member
UNION ALL
recursive_query -- 引用CTE名称的递归成员
SELECT * FROM cte_name;
</code></pre>
<p>递归CTE由三个主要部分组成:</p>
<ul>
<li>初始<a href="https://www.begtut.com/mysql/mysql-select-statement-query-data.html">查询</a> 形成CTE结构的基本结果集. 初始查询部分称为锚成员.</li>
<li>递归查询部分是引用CTE名称的查询 因此 它被称为递归成员. 递归成员由<code>UNION ALL</code>或<code>UNION DISTINCT</code>运算符与锚成员连接.</li>
<li>终止条件 确保递归成员不返回任何行时停止递归.</li>
</ul>
<p>递归CTE的执行顺序如下:</p>
<ol>
<li>首先 将成员分为两部分: 锚点和递归成员.</li>
<li>接下来 执行锚成员以形成基本结果集( <code>R0</code>)  并将此基本结果集用于下一次迭代.</li>
<li>然后 执行带有<code>Ri</code>结果集作为输入的递归成员并将其<code>Ri+1</code>作为输出.</li>
<li>之后 重复第三步 直到递归成员返回空结果集 换句话说 满足终止条件.</li>
<li>最后 使用<code>UNION ALL</code>运算符将结果集从R0到Rn组合.</li>
</ol>
</blockquote>
<pre><code class="language-mysql"># 生成斐波那契数列
WITH RECURSIVE fibonacci (n, fib_n, next_fib_n) AS
(
  SELECT 1, 0, 1
  UNION ALL
  SELECT n + 1, next_fib_n, fib_n + next_fib_n
    FROM fibonacci WHERE n &lt; 10
)
SELECT * FROM fibonacci;
</code></pre>
<pre><code class="language-bash">+------+-------+------------+
| n    | fib_n | next_fib_n |
+------+-------+------------+
|    1 |     0 |          1 |
|    2 |     1 |          1 |
|    3 |     1 |          2 |
|    4 |     2 |          3 |
|    5 |     3 |          5 |
|    6 |     5 |          8 |
|    7 |     8 |         13 |
|    8 |    13 |         21 |
|    9 |    21 |         34 |
|   10 |    34 |         55 |
+------+-------+------------+
10 rows in set (0.00 sec)
</code></pre>
<h2 id="二-日历">二. 日历</h2>
<pre><code class="language-bash">+--------+--------+--------+--------+--------+--------+--------+
| 星期一  | 星期二 | 星期三  | 星期四 | 星期五  | 星期六  | 星期日 |
+--------+--------+--------+--------+--------+--------+--------+
|   NULL |   NULL |      1 |      2 |      3 |      4 |      5 |
|      6 |      7 |      8 |      9 |     10 |     11 |     12 |
|     13 |     14 |     15 |     16 |     17 |     18 |     19 |
|     20 |     21 |     22 |     23 |     24 |     25 |     26 |
|     27 |     28 |     29 |     30 |     31 |   NULL |   NULL |
+--------+--------+--------+--------+--------+--------+--------+
5 rows in set (0.00 sec)
</code></pre>
<pre><code class="language-bash">MySQL root@localhost:(none)&gt; select current_date();
+----------------+
| current_date() |
+----------------+
| 2023-03-13     |
+----------------+
1 row in set
Time: 0.004s
</code></pre>
<pre><code class="language-mysql">WITH RECURSIVE calendar ( init_date ) AS (
    # 生成第一天的数据, 可以使用其他方式来生成
	SELECT
		subdate( adddate( CURRENT_DATE, INTERVAL 1 DAY ), INTERVAL dayofmonth( CURRENT_DATE ) DAY ) UNION ALL
	SELECT
		adddate( init_date, INTERVAL 1 DAY )
	FROM
		calendar
	WHERE
    	# 循环到最后一天
		init_date &lt; last_day( CURRENT_DATE )
	) SELECT
	*
FROM
	calendar;
</code></pre>
<pre><code class="language-bash">+------------+
| int_date   |
+------------+
| 2023-03-01 |
| 2023-03-02 |
| 2023-03-03 |
| 2023-03-04 |
| 2023-03-05 |
| 2023-03-06 |
| 2023-03-07 |
| 2023-03-08 |
| 2023-03-09 |
| 2023-03-10 |
| 2023-03-11 |
| 2023-03-12 |
| 2023-03-13 |
| 2023-03-14 |
| 2023-03-15 |
| 2023-03-16 |
| 2023-03-17 |
| 2023-03-18 |
| 2023-03-19 |
| 2023-03-20 |
| 2023-03-21 |
| 2023-03-22 |
| 2023-03-23 |
| 2023-03-24 |
| 2023-03-25 |
| 2023-03-26 |
| 2023-03-27 |
| 2023-03-28 |
| 2023-03-29 |
| 2023-03-30 |
| 2023-03-31 |
+------------+
31 rows in set (0.00 sec)
</code></pre>
<pre><code class="language-mysql">WITH RECURSIVE calendar ( init_date ) AS (
	SELECT
		subdate( adddate( CURRENT_DATE, INTERVAL 1 DAY ), INTERVAL dayofmonth( CURRENT_DATE ) DAY ) UNION ALL
	SELECT
		adddate( init_date, INTERVAL 1 DAY )
	FROM
		calendar
	WHERE
		init_date &lt; last_day( CURRENT_DATE )
	) SELECT
	init_date,
	# 返回日期对应的周
	WEEK ( init_date, 1 ) AS wk,
	dayofmonth( init_date ) AS dm,
	dayofweek( init_date ) AS dw
FROM
	calendar;
</code></pre>
<pre><code class="language-bash">+------------+------+------+------+
| init_date  | wk   | dm   | dw   |
+------------+------+------+------+
| 2023-03-01 |    9 |    1 |    4 |
| 2023-03-02 |    9 |    2 |    5 |
| 2023-03-03 |    9 |    3 |    6 |
| 2023-03-04 |    9 |    4 |    7 |
| 2023-03-05 |    9 |    5 |    1 |
| 2023-03-06 |   10 |    6 |    2 |
| 2023-03-07 |   10 |    7 |    3 |
| 2023-03-08 |   10 |    8 |    4 |
| 2023-03-09 |   10 |    9 |    5 |
| 2023-03-10 |   10 |   10 |    6 |
| 2023-03-11 |   10 |   11 |    7 |
| 2023-03-12 |   10 |   12 |    1 |
| 2023-03-13 |   11 |   13 |    2 |
| 2023-03-14 |   11 |   14 |    3 |
| 2023-03-15 |   11 |   15 |    4 |
| 2023-03-16 |   11 |   16 |    5 |
| 2023-03-17 |   11 |   17 |    6 |
| 2023-03-18 |   11 |   18 |    7 |
| 2023-03-19 |   11 |   19 |    1 |
| 2023-03-20 |   12 |   20 |    2 |
| 2023-03-21 |   12 |   21 |    3 |
| 2023-03-22 |   12 |   22 |    4 |
| 2023-03-23 |   12 |   23 |    5 |
| 2023-03-24 |   12 |   24 |    6 |
| 2023-03-25 |   12 |   25 |    7 |
| 2023-03-26 |   12 |   26 |    1 |
| 2023-03-27 |   13 |   27 |    2 |
| 2023-03-28 |   13 |   28 |    3 |
| 2023-03-29 |   13 |   29 |    4 |
| 2023-03-30 |   13 |   30 |    5 |
| 2023-03-31 |   13 |   31 |    6 |
+------------+------+------+------+
31 rows in set (0.00 sec)
</code></pre>
<p>这里涉及到行列转换问题</p>
<h3 id="21-行列转换">2.1 行列转换</h3>
<p>这里使用<code>MySQL</code>和<code>PostgreSQL</code>进行对比</p>
<pre><code class="language-bash">create table test_b(name char(4), s_type varchar(10), s_value int);

insert into test_b values('alex','weight', 60);
insert into test_b values('alex','age', 60);
insert into test_b values('alex','heigh', 160);
insert into test_b values('tony','weight', 78);
insert into test_b values('tony','age', 35);
insert into test_b values('tony','heigh', 170);
</code></pre>
<pre><code class="language-bash"> name | s_type | s_value
------+--------+---------
 alex | weight |      60
 alex | age    |      60
 alex | heigh  |     160
 tony | weight |      78
 tony | age    |      35
 tony | heigh  |     170
(6 rows)
</code></pre>
<h4 id="211-postgresql">2.1.1 PostgreSQL</h4>
<p><code>postgresql</code>支持<code>extension</code></p>
<pre><code class="language-bash">test_db=# select name from pg_available_extensions;
        name
---------------------
 adminpack
 amcheck
 autoinc
 bloom
 bool_plperl
 bool_plperlu
 btree_gin
 btree_gist
 citext
 cube
 dblink
 dict_int
 dict_xsyn
 dummy_index_am
 earthdistance
 file_fdw
 fuzzystrmatch
 hstore
 hstore_plperl
 hstore_plperlu
 hstore_plpython3u
 insert_username
 intagg
 intarray
 isn
 jsonb_plperl
 jsonb_plperlu
 jsonb_plpython3u
 lo
 ltree
 ltree_plpython3u
 moddatetime
 old_snapshot
 pageinspect
 pgcrypto
 pgrowlocks
 pgstattuple
 pg_buffercache
 pg_freespacemap
 pg_prewarm
 pg_stat_statements
 pg_surgery
 pg_trgm
 pg_visibility
 pg_walinspect
 pldbgapi
 plperl
 plperlu
 plpgsql
 plpython3u
 plsample
 pltcl
 pltclu
 postgres_fdw
 refint
 seg
 spgist_name_ops
 sslinfo
 system_stats
 tablefunc
 tcn
 test_bloomfilter
 test_ext1
 test_ext2
 test_ext3
 test_ext4
 test_ext5
 test_ext6
 test_ext7
 test_ext8
 test_ext_cine
 test_ext_cor
 test_ext_cyclic1
 test_ext_cyclic2
 test_ext_evttrig
 test_ginpostinglist
 test_integerset
 test_pg_dump
 test_predtest
 test_rbtree
 test_regex
 tsm_system_rows
 tsm_system_time
 unaccent
 uuid-ossp
 xml2
(86 rows)
</code></pre>
<blockquote>
<p><code>CREATE EXTENSION</code> loads a new extension into the current database. There must not be an extension of the same name already loaded.</p>
<p>Loading an extension essentially amounts to running the extension's script file. The script will typically create new SQL objects such as functions, data types, operators and index support methods. <code>CREATE EXTENSION</code> additionally records the identities of all the created objects, so that they can be dropped again if <code>DROP EXTENSION</code> is issued.</p>
<p>The user who runs <code>CREATE EXTENSION</code> becomes the owner of the extension for purposes of later privilege checks, and normally also becomes the owner of any objects created by the extension's script.</p>
<p>Loading an extension ordinarily requires the same privileges that would be required to create its component objects. For many extensions this means superuser privileges are needed. However, if the extension is marked <em>trusted</em> in its control file, then it can be installed by any user who has <code>CREATE</code> privilege on the current database. In this case the extension object itself will be owned by the calling user, but the contained objects will be owned by the bootstrap superuser (unless the extension's script explicitly assigns them to the calling user). This configuration gives the calling user the right to drop the extension, but not to modify individual objects within it.</p>
</blockquote>
<pre><code class="language-bash">SELECT
	*
FROM
	crosstab ( 'select name, s_type, s_value from test_b' ) AS ct ( NAME CHAR ( 4 ), weight INT, age INT, heigh INT );
</code></pre>
<pre><code class="language-bash">ERROR:  function crosstab(unknown) does not exist
</code></pre>
<pre><code class="language-mysql"># 需要先执行
CREATE EXTENSION IF NOT EXISTS tablefunc;
</code></pre>
<pre><code class="language-bash">test_db=# SELECT * FROM crosstab('select name, s_type, s_value from test_b') AS ct(name char(4), weight int, age int, heigh int);
 name | weight | age | heigh
------+--------+-----+-------
 alex |     60 |  60 |   160
 tony |     78 |  35 |   170
(2 rows)
</code></pre>
<p>非常简单, 在 <code>postgresql</code>之下.</p>
<p><a href="https://www.postgresql.org/docs/current/tablefunc.html">PostgreSQL: Documentation: 15: F.43. tablefunc</a></p>
<h4 id="212-mysql">2.1.2 MySQL</h4>
<pre><code class="language-bash">MySQL root@localhost:test_db&gt; select name,
                           -&gt; sum(case when s_type='age' then s_value else 0 end) as age,
                           -&gt; sum(case when s_type='heigh' then s_value else 0 end) as heigh,
                           -&gt; sum(case when s_type='weight' then s_value else 0 end) as weight
                           -&gt; from test_b group by name;
+------+-----+-------+--------+
| name | age | heigh | weight |
+------+-----+-------+--------+
| alex | 60  | 160   | 60     |
| tony | 35  | 170   | 78     |
+------+-----+-------+--------+
2 rows in set

MySQL root@localhost:test_db&gt; select name,
                           -&gt; max(case when s_type='age' then s_value else 0 end) as age,
                           -&gt; max(case when s_type='heigh' then s_value else 0 end) as heigh,
                           -&gt; max(case when s_type='weight' then s_value else 0 end) as weight
                           -&gt; from test_b group by name;
+------+-----+-------+--------+
| name | age | heigh | weight |
+------+-----+-------+--------+
| alex | 60  | 160   | 60     |
| tony | 35  | 170   | 78     |
+------+-----+-------+--------+
2 rows in set
Time: 0.007s
</code></pre>
<pre><code class="language-mysql">WITH RECURSIVE calendar ( init_date ) AS (
	SELECT
		subdate( adddate( CURRENT_DATE, INTERVAL 1 DAY ), INTERVAL dayofmonth( CURRENT_DATE ) DAY ) UNION ALL
	SELECT
		adddate( init_date, INTERVAL 1 DAY )
	FROM
		calendar
	WHERE
		init_date &lt; last_day( CURRENT_DATE )
	),
	a AS (
	SELECT
		init_date,
		WEEK ( init_date, 1 ) AS wk,
		dayofmonth( init_date ) AS dm,
		dayofweek( init_date ) - 1 AS dw
	FROM
		calendar
	) SELECT
	max(
	IF
	( dw = 1, dm, NULL )) AS &quot;星期一&quot;,
	max(
	IF
	( dw = 2, dm, NULL )) AS &quot;星期二&quot;,
	max(
	IF
	( dw = 3, dm, NULL )) AS &quot;星期三&quot;,
	max(
	IF
	( dw = 4, dm, NULL )) AS &quot;星期四&quot;,
	max(
	IF
	( dw = 5, dm, NULL )) AS &quot;星期五&quot;,
	max(
	IF
	( dw = 6, dm, NULL )) AS &quot;星期六&quot;,
	max(
	IF
	( dw = 0, dm, NULL )) AS &quot;星期日&quot;
FROM
	a
GROUP BY
	wk;
</code></pre>
<pre><code class="language-bash">+--------+--------+--------+--------+--------+--------+--------+
| 星期一 | 星期二  | 星期三  | 星期四 | 星期五  | 星期六  | 星期日 |
+--------+--------+--------+--------+--------+--------+--------+
|   NULL |   NULL |      1 |      2 |      3 |      4 |      5 |
|      6 |      7 |      8 |      9 |     10 |     11 |     12 |
|     13 |     14 |     15 |     16 |     17 |     18 |     19 |
|     20 |     21 |     22 |     23 |     24 |     25 |     26 |
|     27 |     28 |     29 |     30 |     31 |   NULL |   NULL |
+--------+--------+--------+--------+--------+--------+--------+
5 rows in set (0.00 sec)
</code></pre>
<p>不管是<code>max, min, sum</code>操作, 其原理都是类似的, 但是需要注意不能使用<code>any_value</code>.</p>
<h3 id="22-涉及的日期处理函数">2.2 涉及的日期处理函数</h3>
<ul>
<li>current_date, 当前日期</li>
<li>subdate, 减掉间隔</li>
<li>adddate, 增加间隔</li>
<li>last_day, 返回月的最后一天</li>
<li>week, 日期所在的周(一年)</li>
<li>dayofmonth, 日所在的月</li>
<li>dayofweek, 日所在星期</li>
</ul>

            </div>
            
            
              <div class="post-footer">
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong class="language" data-lan="author">本文作者：</strong>
      Lian
    </li>
    <li class="post-copyright-link">
      <strong class="language" data-lan="link">本文链接：</strong>
      <a href="https://Kyouichirou.github.io/post/mysql-di-gui-ri-qi/" title="MySQL-递归-日期">https://Kyouichirou.github.io/post/mysql-di-gui-ri-qi/</a>
    </li>
    <li class="post-copyright-license">
      <strong class="language" data-lan="copyright">版权声明： </strong>
      本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！
    </li>
  </ul>
  <div class="tags">
    
      <a href="https://Kyouichirou.github.io/tag/7Syg7ifp4/"># postgresql</a>
    
      <a href="https://Kyouichirou.github.io/tag/53itHjBFa/"># mysql</a>
    
  </div>
  <div class="nav">
    <div class="nav-prev">
      
        <i class="fa fa-chevron-left"></i>
        <a class="nav-pc-next" title="PostgreSQL简单使用体验" href="https://Kyouichirou.github.io/post/postgresql-jian-dan-shi-yong-ti-yan/">PostgreSQL简单使用体验</a class="nav-pc-next">
        <a class="nav-mobile-prev" title="PostgreSQL简单使用体验" href="https://Kyouichirou.github.io/post/postgresql-jian-dan-shi-yong-ti-yan/">上一篇</a>
      
    </div>
    <div class="nav-next">
      
        <a class="nav-pc-next" title=" MySQL命令行工具_mycli中文乱码解决" href="https://Kyouichirou.github.io/post/mysql-ming-ling-xing-gong-ju-_mycli-zhong-wen-luan-ma-jie-jue/"> MySQL命令行工具_mycli中文乱码解决</a>
        <a class="nav-mobile-next" title=" MySQL命令行工具_mycli中文乱码解决" href="https://Kyouichirou.github.io/post/mysql-ming-ling-xing-gong-ju-_mycli-zhong-wen-luan-ma-jie-jue/">下一篇</a>
        <i class="fa fa-chevron-right"></i>
      
    </div>
  </div>
</div>
            
            
  

          </div>
        </div>
      </div>
    </div>
    <div class="footer-box">
  <footer class="footer">
    <center id="runTimeBox">
      已运行:<span id="run_time"></span>
    </center>
    <span id="busuanzi_container_site_pv">浏览数:<span id="busuanzi_value_site_pv"></span> 次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">访客数:<span id="busuanzi_value_site_uv"></span> 人</span>

    <script>
      BirthDay = new Date('');
      if (BirthDay.getTime()) {
        function runTime() {
          str = "";
          today = new Date();
          timeold = today.getTime() - BirthDay.getTime();
          msPerDay = 24 * 60 * 60 * 1000;
          e_daysold = timeold / msPerDay;
          daysold = Math.floor(e_daysold);
          str += daysold + "天";
          return str;
        }
        setInterval(function () {
          $("#run_time").html(runTime());
        }, 1000);
      } else {
        document.querySelector('.footer').removeChild(document.querySelector('#runTimeBox'));
      }
    </script>
    <div class="poweredby">
      Powered by <a href="https://github.com/Kyouichirou" target="_blank">Kyouichirou</a>
    </div>
  </footer>
  
    
      <div class="drawer-box left" id="drawer_box">
        <span class="muse-line muse-line-first"></span>
        <span class="muse-line muse-line-middle"></span>
        <span class="muse-line muse-line-last"></span>
      </div>
      
        <div class="mist back-to-top" id="back_to_top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
        
          
            
              <div class="bg-img">
                <img src="https://s1.ax1x.com/2023/03/24/ppBNvm6.jpg" />
              </div>
              
                
                  
                        
</div>
<script>
  let sideBarOpen = "sidebar-open";
  let body = document.body;
  let back2Top = document.querySelector("#back_to_top"),
    back2TopText = document.querySelector("#back_to_top_text"),
    drawerBox = document.querySelector("#drawer_box"),
    rightSideBar = document.querySelector(".sidebar"),
    viewport = document.querySelector("body");

  function scrollAnimation(currentY, targetY) {
    let needScrollTop = targetY - currentY;
    let _currentY = currentY;
    setTimeout(() => {
      const dist = Math.ceil(needScrollTop / 10);
      _currentY += dist;
      window.scrollTo(_currentY, currentY);
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY);
      } else {
        window.scrollTo(_currentY, targetY);
      }
    }, 1);
  }

  back2Top.addEventListener("click", function (e) {
    scrollAnimation(document.scrollingElement.scrollTop, 0);
    e.stopPropagation();
    return false;
  });

  window.addEventListener("scroll", function (e) {
    let percent =
      (document.scrollingElement.scrollTop /
        (document.scrollingElement.scrollHeight -
          document.scrollingElement.clientHeight)) *
      100;
    if (percent > 1 && !back2Top.classList.contains("back-top-active")) {
      back2Top.classList.add("back-top-active");
    }
    if (percent == 0) {
      back2Top.classList.remove("back-top-active");
    }
    if (back2TopText) {
      back2TopText.textContent = Math.floor(percent);
    }
  });

  let hasCacu = false;
  window.addEventListener("resize", function (e) {
    calcuHeight();
  });

  function calcuHeight() {
    // 动态调整站点概览高度
    if (
      (!hasCacu && back2Top.classList.contains("pisces")) ||
      back2Top.classList.contains("gemini")
    ) {
      let sideBar = document.querySelector(".sidebar");
      let navUl = document.querySelector("#site_nav");
      sideBar.style =
        "margin-top:" + (navUl.offsetHeight + navUl.offsetTop + 15) + "px;";
      hasCacu = true;
    }
  }
  calcuHeight();

  let open = false,
    MOTION_TIME = 300,
    RIGHT_MOVE_DIS = "320px";

  if (drawerBox) {
    let rightMotions = document.querySelectorAll(".right-motion");
    let right = drawerBox.classList.contains("right");

    let transitionDir = right
      ? "transition.slideRightIn"
      : "transition.slideLeftIn";

    let openProp, closeProp;
    if (right) {
      openProp = {
        paddingRight: RIGHT_MOVE_DIS,
      };
      closeProp = {
        paddingRight: "0px",
      };
    } else {
      openProp = {
        paddingLeft: RIGHT_MOVE_DIS,
      };
      closeProp = {
        paddingLeft: "0px",
      };
    }

    drawerBox.onclick = function () {
      open = !open;
      jQuery.Velocity(rightSideBar, "stop");
      jQuery.Velocity(viewport, "stop");
      jQuery.Velocity(rightMotions, "stop");
      if (open) {
        jQuery.Velocity(
          rightSideBar,
          {
            width: RIGHT_MOVE_DIS,
          },
          {
            duration: MOTION_TIME,
            begin: function () {
              jQuery.Velocity(rightMotions, transitionDir, {});
            },
          }
        );
        jQuery.Velocity(viewport, openProp, {
          duration: MOTION_TIME,
        });
      } else {
        jQuery.Velocity(
          rightSideBar,
          {
            width: "0px",
          },
          {
            duration: MOTION_TIME,
            begin: function () {
              jQuery.Velocity(rightMotions, {
                opacity: 0,
              });
            },
          }
        );
        jQuery.Velocity(viewport, closeProp, {
          duration: MOTION_TIME,
        });
      }
      for (let i = 0; i < drawerBox.children.length; i++) {
        drawerBox.children[i].classList.toggle("muse-line");
      }
      drawerBox.classList.toggle(sideBarOpen);
    };
  }

  // 链接跳转
  let newWindow = "false";
  if (newWindow === "true") {
    let links = document.querySelectorAll(".post-body a");
    links.forEach((item) => {
      if (!item.classList.contains("btn")) {
        item.setAttribute("target", "_blank");
      }
    });
  }

  let faSearch = document.querySelector("#fa_search");
  faSearch &&
    faSearch.addEventListener("click", function () {
      document.querySelector("#search_mask").style = "";
    });

  // 代码高亮
  hljs.initHighlightingOnLoad();

  // 离开当前页title变化
  var leaveTitle = "";
  var normal_title = document.title;
  if (leaveTitle) {
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState == "hidden") {
        normal_title = document.title;
        document.title = leaveTitle;
      } else {
        document.title = normal_title;
      }
    });
  }
</script>

<link rel="stylesheet" href="/media/css/jquery.fancybox.css" />
<script src="/media/js/jquery.fancybox.js"></script>

<script>
  let images = document.querySelectorAll(".section img");
  images.forEach((image) => {
    var parent = image.parentElement;
    var next = image.nextElementSibling;
    parent.removeChild(image);
    var aelem = document.createElement("a");
    aelem.href = image.src;
    aelem.dataset["fancybox"] = "images";
    aelem.dataset["rel"] = "fancybox-button";
    aelem.classList.add("fancybox");
    aelem.appendChild(image);
    parent.insertBefore(aelem, next);
  });
</script>
    <div class="reward-mask" style="display: none;">
  <div class="reward-relative">
    <span class="close" aria-hidden="true">x</span>
    <div class="reward-body">
      <h2>感谢您的支持，我会继续努力的!</h2>
      <div class="reward-img-box">
        <div style="position: relative; width: 140px; height: 140px;">
          
          
          
        </div>
      </div>
      <p class="reward-word">扫码打赏，你说多少就多少</p>
      <p class="reward-tip"> </p>
    </div>
    <div class="bottom">
      
      
    </div>
  </div>
</div>
<style>
  .reward-mask {
    position: fixed;
    z-index: 99999;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #00000054;
  }

  .reward-relative {
    position: relative;
    width: 480px;
    text-align: center;
    margin: 0 auto;
    border-radius: 5px;
    background-color: #fff;
    top: 50%;
    margin-top: -205px;
  }

  .reward-relative .close {
    position: absolute;
    right: 10px;
    font-weight: normal;
    font-size: 16px;
    color: #929292;
  }

  .reward-body {
    padding: 40px 20px 20px;
  }

  .bottom {
    display: flex;
  }

  .reward-btn {
    text-align: center;
  }

  .reward-btn-text {
    display: inline-block;
    cursor: pointer;
    width: 60px;
    height: 60px;
    line-height: 60px;
    border-radius: 50%;
    background-color: #ff9734;
    color: #FFF;
    margin-top: 20px;
  }

  .pay-text {
    margin-top: 10px;
    padding: 10px;
    flex: 1;
    transition: all .2s linear;
  }

  .pay-text:hover {
    background-color: #a5a5a536;
  }

  .reward-body h2 {
    padding-top: 10px;
    text-align: center;
    color: #a3a3a3;
    font-size: 16px;
    font-weight: normal;
    margin: 0 0 20px;
  }

  .reward-body h2:after,
  .reward-body h2:before {
    font-family: Arial, Helvetica, sans-serif;
    background: 0 0;
    width: 0;
    height: 0;
    font-style: normal;
    color: #eee;
    font-size: 80px;
    position: absolute;
    top: 20px;
  }

  .reward-body h2:before {
    content: '\201c';
    left: 50px;
  }

  .reward-body h2:after {
    content: '\201d';
    right: 80px;
  }

  .reward-img-box {
    display: inline-block;
    padding: 10px;
    border: 6px solid #ea5f00;
    margin: 0 auto;
    border-radius: 3px;
    position: relative;
  }

  .reward-img {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 100%;
    height: 100%;
  }

  @media (max-width: 767px) {
    .reward-relative {
      height: 100%;
      top: 0px;
      margin-top: 0;
      width: auto;
    }

    .reward-relative .bottom {
      flex-direction: column;
    }

    .reward-relative .pay-text {
      width: 80%;
      margin: 5px auto;
      border: 1px solid silver;
      padding: 6px;
      border-radius: 4px;
    }

    .reward-body h2:after {
      right: 40px;
    }

    .reward-body h2:after,
    .reward-body h2:before {
      font-size: 60px;
    }

    .reward-body h2:before {
      left: 20px;
    }
  }
</style>
<script>
  !function () {
    var mask = document.querySelector('.reward-mask');
    let close = document.querySelector('.reward-relative .close');
    let rewardBtn = document.querySelector('.reward-btn');

    let zfb = document.querySelector('#zfb'),
      wx = document.querySelector('#wx'),
      zfbBtn = document.querySelector('#zfbBtn'),
      wxBtn = document.querySelector('#wxBtn');

    if (zfbBtn && wxBtn) {
      zfbBtn.addEventListener('click', () => {
        jQuery.Velocity(zfb, 'transition.slideLeftIn', {
          duration: 400
        });
        jQuery.Velocity(wx, 'transition.slideRightOut', {
          display: 'none',
          duration: 400
        });
      });

      wxBtn.addEventListener('click', () => {
        jQuery.Velocity(wx, 'transition.slideRightIn', {
          duration: 400
        });
        jQuery.Velocity(zfb, 'transition.slideLeftOut', {
          display: 'none',
          duration: 400
        });
      });
    }

    rewardBtn && rewardBtn.addEventListener('click', (e) => {
      jQuery.Velocity(mask, 'transition.slideDownIn', {
        duration: 400
      })
    });

    close.addEventListener('click', (e) => {
      e.preventDefault();
      jQuery.Velocity(mask, 'transition.slideUpOut', {
        duration: 400
      })
    })
  }()
</script>

  </div>
</body>

<input hidden id="copy" />
<script>
  !function () {
    let times = document.querySelectorAll('.publish-time');
    for (let i = 0; i < times.length; i++) {
      let date = times[i].dataset.t;
      let time = Math.floor((new Date().getTime() - new Date(date).getTime()) / 1000);
      if (time < 60) {
        str = time + '秒之前';
      } else if (time < 3600) {
        str = Math.floor(time / 60) + '分钟之前';
      } else if (time >= 3600 && time < 86400) {
        str = Math.floor(time / 3600) + '小时之前';
      } else if (time >= 86400 && time < 259200) {
        str = Math.floor(time / 86400) + '天之前';
      } else {
        str = times[i].textContent;
      }
      times[i].textContent = str;
    }
  }();
</script>

<script>
  let language = 'en';
  if (language !== '') {
    let map = new Map();
    if (language === 'en') {
      map.set('search', 'Search');
      map.set('category', 'Categories');
      map.set('article', 'Articles');
      map.set('tag', 'Tags');
      map.set('top', 'Top');
      map.set('publish', 'published');
      map.set('minute', ' minutes');
      map.set('read-more', 'Read More');
      map.set('view', 'View');
      map.set('words', ' words');
      map.set('category-in', 'category in');
      map.set('preview', 'Meta');
      map.set('index', 'Toc');
      map.set('no-archives', "You haven't created yet");
      map.set('archives', " articles in total");
      map.set('cloud-tags', " tags in total");
      map.set('copyright', "Copyright: ");
      map.set('author', "Author: ");
      map.set('link', "Link: ");
      map.set('leave-message', "Leave a message");
      map.set('format', "Links Format");
      map.set('site-name', "Name: ");
      map.set('site-link', "Link: ");
      map.set('site-desc', "Desc: ");
      map.set('stat', " related results, taking ");
      map.set('stat-time', " ms");
      map.set('site-img', "Image: ");
    }

    if (map.size > 0) {
      let lanElems = document.querySelectorAll('.language');
      lanElems.forEach(elem => {
        let lan = elem.dataset.lan, text = map.get(lan);
        if (elem.__proto__ === HTMLInputElement.prototype) {
          elem.placeholder = text
        } else {
          if (elem.dataset.count) {
            text = elem.dataset.count + text;
          }
          elem.textContent = text;
        }
      })
    }
  }

  window.Clipboard = (function (window, document, navigator) {
    var textArea,
      copy;

    // 判断是不是ios端
    function isOS() {
      return navigator.userAgent.match(/ipad|iphone/i);
    }
    //创建文本元素
    function createTextArea(text) {
      textArea = document.createElement('textArea');
      textArea.value = text;
      textArea.style.width = 0;
      textArea.style.height = 0;
      textArea.clientHeight = 0;
      textArea.clientWidth = 0;
      document.body.appendChild(textArea);
    }
    //选择内容
    function selectText() {
      var range,
        selection;

      if (isOS()) {
        range = document.createRange();
        range.selectNodeContents(textArea);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        textArea.setSelectionRange(0, 999999);
      } else {
        textArea.select();
      }
    }

    //复制到剪贴板
    function copyToClipboard() {
      try {
        document.execCommand("Copy")
      } catch (err) {
        alert("复制错误！请手动复制！")
      }
      document.body.removeChild(textArea);
    }

    copy = function (text) {
      createTextArea(text);
      selectText();
      copyToClipboard();
    };

    return {
      copy: copy
    };
  })(window, document, navigator);

  function copyCode(e) {
    if (e.srcElement.tagName === 'SPAN' && e.srcElement.classList.contains('copy-code')) {
      let code = e.currentTarget.querySelector('code');
      var text = code.innerText;
      if (e.srcElement.textContent === '复制成功') {
        return;
      }
      e.srcElement.textContent = '复制成功';
      (function (elem) {
        setTimeout(() => {
          if (elem.textContent === '复制成功') {
            elem.textContent = '复制代码'
          }
        }, 1000);
      })(e.srcElement)
      Clipboard.copy(text);
    }
  }

  let pres = document.querySelectorAll('pre');
  pres.forEach(pre => {
    let code = pre.querySelector('code');
    let copyElem = document.createElement('span');
    copyElem.classList.add('copy-code');
    copyElem.textContent = '复制代码';
    pre.appendChild(copyElem);
    pre.onclick = copyCode
  })

</script>
<script src="/media/js/motion.js"></script>


  <script
    src="https://cdn.staticfile.org/smooth-scroll/16.1.3/smooth-scroll.polyfills.min.js"></script>
  <script>
    var scroll = new SmoothScroll('a[href*="#"]', {
      speed: 200
    });
  </script>






  <div class="snow-container"></div>
  <script src="/media/js/bg/snow.js"></script>

</html>